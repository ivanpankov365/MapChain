<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<meta http-equiv="X-UA-Compatible" content="ie=edge">-->
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="deployContract.js"></script>
    <script src="createQestSubmit.js"></script>
    <script src="naviAddress.js"></script>
    <script src="navi.js"></script>
    <script>
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            alert('Please activate MetaMask Plugin and reload page! You can find it here: https://metamask.io/')
        }
    </script>
</head>

<body>
<h1>Hi! Here you can create your new super mega quest!!</h1>
<form action="">
    <p><b>Price for the one step:</b><br>
        <input id="price" type="text" size="40" required>
    </p>
    <p><b>Number of steps:</b><br>
        <input id="steps" type="text" size="40" required>
    </p><input type="button" onclick="createQestSubmit()" value="Create my fucking Quest"><br />
</form>

<script>
    /*let container = '7'; // Это адресный контейнер. 7 - это Россия.
    let naviaddress = '0022'; // Это адрес. [7]0022 - адрес российского офиса Naviaddress
    let url = 'https://staging-api.naviaddress.com/api/v1.5/Addresses/'
        + container+'/' + naviaddress;

    fetch(url).then((res1)=>
        res1.json().then((res2)=>{
            console.log('RESULT');
            console.log(res2.result);
        })
    );*/
    let email = 'ivan.pankov.365@yandex.ru';
    let password = 'GreatTrango6b';
    getToken(email,password).then((token)=>{
        createNaviaddress(token);
    });
    /*getToken(email,password).then((token)=>{
        createNaviaddress(token);
    });*/

    // Получить токен
    function getToken(email,password) {
        return new Promise((resolve,reject) => {
            let url = 'https://staging-api.naviaddress.com/api/v1.5/Sessions';
            let params = {
                email:email,
                password:password
            };

            fetch(url,
                {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    method: 'POST',
                    body: JSON.stringify(params)
                })
                .then((res1) => {
                    res1.json().then((res2) => resolve(res2.token));
                });
        });
    }

    function createNaviaddress(token) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
                (position)=>{
                    let coords = position.coords;

                    let url = 'https://staging-api.naviaddress.com/api/v1.5/addresses/';
                    let body = {
                        lat: '69',
                        lng: '37',
                        address_type: "free",
                        default_lang: "ru"
                    };

                    fetch(url,
                        {
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'auth-token': token
                            },
//				    mode:'no-cors',
                            method: 'POST',
                            body: JSON.stringify(body)
                        }).then((res1) => {
                        res1.json().then((res2) => {
                            acceptNaviaddress(token,res2.result.container, res2.result.naviaddress);
                        });
                    });
                });

        } else {
            alert("Геолокация не поддерживается вашим браузером");
        }
    }

    // Подтверждаем навиадрес
    function acceptNaviaddress(token,container,naviaddress) {
        let url = 'https://staging-api.naviaddress.com/api/v1.5/addresses/accept/'
            +container+'/'+naviaddress;
        let body = {};

        fetch(url,
            {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'auth-token': token
                },
                method: "POST",
                body: JSON.stringify(body)
            }).then((res1) => {
            res1.json().then((res2) => {
                putNaviaddress(token, res2.result);
            });
        });
    }

    // Заполняем навиадрес данными
    function putNaviaddress(token,data) {
        console.log(198,data);
        let container = data.container;
        let naviaddress = data.naviaddress;
        let url = 'https://staging-api.naviaddress.com/api/v1.5/addresses/'
            +container+'/'+naviaddress+'?lang=ru';
        let body = {
            name:document.getElementById("description").value,
            description:'Создано программой Инвентаризатор: '+document.getElementById("description").value
        };

        fetch(url,
            {
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'auth-token': token
                },
                method: "PUT",
                body: JSON.stringify(body)
            }).then((res1) => {
            res1.json().then((res2) => {
                let r = res2.result;
                location.href = "get.html?container="+r.container+'&naviaddress='+r.naviaddress;
            });
        });
    }

</script>

</body>

</html>